<div class="avatar-center">
  <!-- Contenedor del avatar -->
  <div class="avatar-wrap" [attr.aria-label]="alt" role="img">

    <!-- Skeleton mientras carga -->
    <ion-skeleton-text *ngIf="isLoading" class="skeleton"></ion-skeleton-text>

    <!-- Imagen si hay URL y no hay error -->
    <img
      *ngIf="avatarUrl && !isError && !isLoading"
      [src]="avatarUrl"
      class="avatar-img"
      [alt]="alt"
      (load)="onLoadOk()"
      (error)="onLoadError()"
      (loadstart)="onStartLoading()"
      decoding="async"
      loading="lazy"
    />

    <!-- Si falla: placeholder o iniciales -->
    <ng-container *ngIf="(!avatarUrl || isError) && !isLoading">
      <ion-avatar class="avatar-img">
        <img [src]="placeholder" [alt]="alt" />
      </ion-avatar>
      <div *ngIf="showInitials" class="initials" aria-hidden="true">
        {{ showInitials }}
      </div>
    </ng-container>

    <!-- Overlay cÃ¡mara en modo edit (llama al servicio global) -->
    <div
      *ngIf="effectiveMode === 'edit'"
      class="avatar-overlay"
      tabindex="0"
      [attr.aria-label]="'Cambiar foto de perfil'"
      (click)="openGalleryFromAvatar()"
    >
      <ion-icon name="camera"></ion-icon>
    </div>

    <!-- Fallback web: input file oculto -->
    <input
      #fileInput
      id="avatar-upload"
      type="file"
      accept="image/*"
      (change)="onFileSelected($event)"
      hidden
    />
  </div>
</div>
