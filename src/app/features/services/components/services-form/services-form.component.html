<ion-header translucent="true">
  <ion-toolbar>
    <ion-title>🏢 Registrar Servicios</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <form [formGroup]="servicesForm" (ngSubmit)="onSubmit()">

    <input type="hidden" formControlName="providerId" />

    <ion-list lines="full" class="service-list" formArrayName="services">
      <ion-accordion-group expand="inset">

        <!-- ===== Servicio (acordeón) ===== -->
        <ion-accordion *ngFor="let _svc of services.controls; let i = index; trackBy: trackByIndex" [value]="i">

          <!-- Header del servicio -->
          <ion-item slot="header" detail="true">
            <ion-label>
              <h2>Servicio {{ i + 1 }}</h2>
              <!-- Mostramos la subcategoría seleccionada -->
              <p>{{ services.at(i).value?.subcategoryName || 'Sin subcategoría' }}</p>
            </ion-label>
            <ion-buttons slot="end">
              <ion-button fill="clear" color="danger" (click)="removeService(i)" type="button"
                [disabled]="isEditMode && services.length === 1">
                Eliminar
              </ion-button>
            </ion-buttons>
          </ion-item>

          <!-- Contenido del servicio (formGroupName en contenedor, no en ion-accordion) -->
          <div class="accordion-content" slot="content" [formGroupName]="i">
            <ion-list class="group-fields" lines="none">

              <ion-item *ngIf="!providerId">
                <ion-label position="stacked">Proveedor</ion-label>
                <fac-select formControlName="providerId" placeholder="Seleccione proveedor" [valueField]="'id'"
                  [labelField]="'name'" [items]="providersAll" (ionChange)="onProviderChange(i, $event)">
                </fac-select>
              </ion-item>
              
       

              <!-- Categoría -->
              <ion-item>
                <ion-label position="stacked">Categoría</ion-label>
                <fac-select formControlName="categoryId" placeholder="Seleccione categoría" [valueField]="'id'"
                  [labelField]="'name'" [items]="categoryAll" (ionChange)="onCategoryChange(i, $event)">
                </fac-select>
              </ion-item>

              <!-- Subcategoría -->
              <ion-item>
                <ion-label position="stacked">Subcategoría</ion-label>
                <fac-select formControlName="subcategoryId" placeholder="Seleccione subcategoría" [valueField]="'id'"
                  [labelField]="'name'" [items]="getAvailableSubcategories(i)"
                  (ionChange)="onSubcategoryChange(i, $event)">
                </fac-select>
              </ion-item>

              <!-- Ítems del servicio (acordeón interno) -->
              <div formArrayName="items" class="service-items">

                <ion-item lines="none">
                  <ion-label>Ítems del servicio {{ itemsFAAt(i).length }}{{ itemsFAAt(i).length === 1 ? '' : 's'
                    }}</ion-label>
                  <ion-button fill="outline" size="small" type="button" (click)="addItem(i)"
                    [disabled]="!canAddNewItem(i)">
                    + Agregar ítem
                  </ion-button>
                </ion-item>

                <ion-accordion-group expand="inset">
                  <ion-accordion *ngFor="let it of itemsFAAt(i).controls; let k = index; trackBy: trackByIndex"
                    [value]="k">

                    <!-- Header del ítem -->
                    <ion-item slot="header" detail="true">
                      <ion-label>
                        <h3 [ngClass]="itemHeaderClass(i,k)">{{ itemHeaderText(i,k) }}</h3>
                        <p>{{ (itemsFAAt(i).at(k).value?.name || '') | slice:0:40 }}</p>
                      </ion-label>

                      <ion-buttons slot="end">
                        <ion-button fill="clear" color="danger" type="button" (click)="removeItem(i, k)"
                          [disabled]="itemsFAAt(i).length === 1">
                          <ion-icon slot="start" name="trash-outline"></ion-icon>
                          Eliminar
                        </ion-button>
                      </ion-buttons>
                    </ion-item>

                    <!-- Contenido del ítem -->
                    <div slot="content" class="accordion-content" [formGroupName]="k">

                      <!-- Nombre -->
                      <ion-item>
                        <!-- ⬇️ ÚNICO CAMBIO EN HTML: usar nameLabelClass -->
                        <ion-label position="stacked" [ngClass]="timeLabelClass2(i,k)">
                          <span [ngClass]="nameLabelClass(i,k)">Nombre</span>
                        </ion-label>
                        <fac-input formControlName="name" type="text" placeholder="Ingrese el nombre del servicio"
                          icon="pricetag">
                        </fac-input>
                      </ion-item>

                      <!-- Descripción -->
                      <ion-item>
                        <ion-label position="stacked">Descripción</ion-label>
                        <fac-textarea formControlName="description" placeholder="Ingrese una descripción"
                          icon="document-text">
                        </fac-textarea>
                      </ion-item>

                      <div class="two-cols">
                      </div>
                      <ion-item>
                        <ion-label position="stacked">
                          <span [ngClass]="timeLabelClass(i,k)">Tiempo (min)</span>
                        </ion-label>
                        <fac-input formControlName="serviceTime" type="number" placeholder="Ej: 45"></fac-input>
                      </ion-item>

                      <ion-item>
                        <ion-label position="stacked">Precio</ion-label>
                        <fac-input formControlName="price" type="text" placeholder="Ej: 1.000"
                          (input)="onPriceInput(i, k, $event)">
                        </fac-input>
                      </ion-item>
                    </div>
                  </ion-accordion>
                </ion-accordion-group>
              </div>

            </ion-list>
          </div>
        </ion-accordion>

      </ion-accordion-group>
    </ion-list>

    <div class="stack-actions">
      <ion-button expand="block" color="primary" type="button" (click)="addService()" [disabled]="isEditMode">
        + Agregar servicio
      </ion-button>

      <ion-button expand="block" color="primary" type="submit">
        {{ submitting ? 'Guardando...' : (isEditMode ? 'Actualizar' : 'Guardar todo') }}
      </ion-button>

      <ion-button expand="block" fill="clear" type="button" (click)="cancel()">
        Cancelar
      </ion-button>
    </div>
  </form>
</ion-content>